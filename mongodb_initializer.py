"""
MongoDB Database Initializer
MediCrew i√ßin MongoDB setup script
"""

import pymongo
from pymongo import MongoClient, ASCENDING, DESCENDING, TEXT
from datetime import datetime
import sys

# ============================================================
# CONFIGURATION
# ============================================================

MONGO_URI = "mongodb://localhost:27017/"
DB_NAME = "medicrew"
COLLECTION_NAME = "pubmed_papers"

# ============================================================
# MongoDB SETUP & INITIALIZATION
# ============================================================

def test_mongodb_connection(uri):
    """MongoDB baƒülantƒ±sƒ±nƒ± test et"""
    try:
        client = MongoClient(uri, serverSelectionTimeoutMS=5000)
        # Ping to test connection
        client.admin.command('ping')
        print("‚úì MongoDB connection successful")
        return client
    except Exception as e:
        print(f"‚ùå MongoDB connection failed: {e}")
        print("\nüí° √á√∂z√ºmler:")
        print("   1. MongoDB √ßalƒ±≈üƒ±yor mu kontrol et: mongod")
        print("   2. Connection string doƒüru mu: mongodb://localhost:27017/")
        print("   3. MongoDB kurulu mu: brew install mongodb-community (macOS)")
        sys.exit(1)


def create_database(client, db_name):
    """Database olu≈ütur (ilk insert'te otomatik olu≈üur)"""
    db = client[db_name]
    print(f"‚úì Database selected: {db_name}")
    return db


def create_collection(db, collection_name):
    """Collection olu≈ütur ve yapƒ±landƒ±r"""
    
    # Collection zaten varsa sil ve yeniden olu≈ütur (temiz ba≈ülangƒ±√ß)
    if collection_name in db.list_collection_names():
        print(f"‚ö†Ô∏è  Collection '{collection_name}' zaten var")
        choice = input("   Silip yeniden olu≈üturmak ister misiniz? (y/n): ")
        if choice.lower() == 'y':
            db[collection_name].drop()
            print(f"   ‚úì Eski collection silindi")
    
    # Collection olu≈ütur (ilk insert'te otomatik olu≈üur)
    collection = db[collection_name]
    print(f"‚úì Collection ready: {collection_name}")
    
    return collection


def create_indexes(collection):
    """Performance i√ßin index'ler olu≈ütur"""
    
    print("\nüìë Creating indexes...")
    
    # 1. PMID (Unique) - primary key gibi
    collection.create_index(
        [("pmid", ASCENDING)],
        unique=True,
        name="idx_pmid_unique"
    )
    print("   ‚úì Unique index: pmid")
    
    # 2. Domain (Filtering i√ßin)
    collection.create_index(
        [("domain", ASCENDING)],
        name="idx_domain"
    )
    print("   ‚úì Index: domain")
    
    # 3. Year (Range queries i√ßin)
    collection.create_index(
        [("year", DESCENDING)],
        name="idx_year"
    )
    print("   ‚úì Index: year")
    
    # 4. Pinecone sync durumu
    collection.create_index(
        [("synced_to_pinecone", ASCENDING)],
        name="idx_synced"
    )
    print("   ‚úì Index: synced_to_pinecone")
    
    # 5. Text search (title + abstract)
    collection.create_index(
        [("title", TEXT), ("abstract", TEXT)],
        name="idx_text_search",
        default_language="english"
    )
    print("   ‚úì Text index: title + abstract")
    
    # 6. Compound index (domain + year)
    collection.create_index(
        [("domain", ASCENDING), ("year", DESCENDING)],
        name="idx_domain_year"
    )
    print("   ‚úì Compound index: domain + year")
    
    # 7. Downloaded_at (timestamp queries)
    collection.create_index(
        [("downloaded_at", DESCENDING)],
        name="idx_downloaded_at"
    )
    print("   ‚úì Index: downloaded_at")
    
    print("\n‚úì All indexes created")


def create_validation_schema(db, collection_name):
    """Document validation rules (optional ama √∂nerilen)"""
    
    print("\nüìã Setting up validation schema...")
    
    # MongoDB'de schema validation (opsiyonel ama iyi practice)
    validator = {
        "$jsonSchema": {
            "bsonType": "object",
            "required": ["pmid", "title"],  # Zorunlu field'lar
            "properties": {
                "pmid": {
                    "bsonType": "string",
                    "description": "PubMed ID - zorunlu ve unique"
                },
                "pmc_id": {
                    "bsonType": ["string", "null"],
                    "description": "PubMed Central ID - opsiyonel"
                },
                "title": {
                    "bsonType": "string",
                    "description": "Paper title - zorunlu"
                },
                "abstract": {
                    "bsonType": ["string", "null"],
                    "description": "Paper abstract"
                },
                "full_text": {
                    "bsonType": ["string", "null"],
                    "description": "Full article text - opsiyonel"
                },
                "year": {
                    "bsonType": ["int", "null"],
                    "minimum": 1900,
                    "maximum": 2100,
                    "description": "Publication year"
                },
                "journal": {
                    "bsonType": ["string", "null"],
                    "description": "Journal name"
                },
                "authors": {
                    "bsonType": ["string", "array", "null"],
                    "description": "Authors - string veya array"
                },
                "domain": {
                    "enum": ["cardiology", "endocrinology", "combined", None],
                    "description": "Medical domain"
                },
                "synced_to_pinecone": {
                    "bsonType": "bool",
                    "description": "Pinecone'a y√ºklendi mi?"
                },
                "downloaded_at": {
                    "bsonType": "date",
                    "description": "Download timestamp"
                },
                "metadata": {
                    "bsonType": ["object", "null"],
                    "description": "Extra flexible data"
                }
            }
        }
    }
    
    # Validation'ƒ± uygula
    try:
        db.command({
            "collMod": collection_name,
            "validator": validator,
            "validationLevel": "moderate"  # moderate = mevcut doc'lar hari√ß
        })
        print("‚úì Validation schema applied")
    except Exception as e:
        print(f"‚ö†Ô∏è  Validation schema uygulanamadƒ± (normal - ilk kez): {e}")


def insert_sample_data(collection):
    """Test i√ßin sample data ekle"""
    
    print("\nüìù Inserting sample documents...")
    
    sample_papers = [
        {
            "pmid": "99999991",
            "title": "Sample Paper: Heart Failure Treatment Guidelines",
            "abstract": "This is a sample abstract for testing purposes...",
            "journal": "Test Journal of Medicine",
            "year": 2024,
            "authors": "Test Author A, Test Author B",
            "domain": "cardiology",
            "pubmed_url": "https://pubmed.ncbi.nlm.nih.gov/99999991/",
            "synced_to_pinecone": False,
            "downloaded_at": datetime.utcnow(),
            "metadata": {
                "query": "test query",
                "has_full_text": False,
                "is_sample": True
            }
        },
        {
            "pmid": "99999992",
            "title": "Sample Paper: Diabetes Management in 2024",
            "abstract": "This is another sample abstract...",
            "journal": "Test Endocrinology Review",
            "year": 2024,
            "authors": ["Smith J", "Doe A"],  # Array format
            "domain": "endocrinology",
            "pubmed_url": "https://pubmed.ncbi.nlm.nih.gov/99999992/",
            "synced_to_pinecone": False,
            "downloaded_at": datetime.utcnow(),
            "metadata": {
                "query": "diabetes test",
                "has_full_text": False,
                "impact_factor": 8.5,
                "is_sample": True
            }
        },
        {
            "pmid": "99999993",
            "title": "Sample Paper: Diabetic Cardiomyopathy",
            "abstract": "Combined domain sample...",
            "full_text": "This paper has full text content for testing...",
            "journal": "Test Combined Medicine",
            "year": 2023,
            "authors": "Johnson M, Lee K, Park S",
            "domain": "combined",
            "pmc_id": "PMC9999999",
            "pubmed_url": "https://pubmed.ncbi.nlm.nih.gov/99999993/",
            "pmc_url": "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9999999/",
            "synced_to_pinecone": False,
            "downloaded_at": datetime.utcnow(),
            "metadata": {
                "query": "combined test",
                "has_full_text": True,
                "citations_count": 42,
                "is_sample": True
            }
        }
    ]
    
    try:
        result = collection.insert_many(sample_papers)
        print(f"‚úì Inserted {len(result.inserted_ids)} sample documents")
        return True
    except Exception as e:
        print(f"‚ö†Ô∏è  Sample data insertion failed: {e}")
        return False


def print_database_stats(db, collection):
    """Database istatistiklerini g√∂ster"""
    
    print("\n" + "="*60)
    print("üìä DATABASE STATISTICS")
    print("="*60)
    
    # Database size
    stats = db.command("dbStats")
    print(f"Database: {db.name}")
    print(f"Collections: {len(db.list_collection_names())}")
    print(f"Database size: {stats['dataSize'] / 1024:.2f} KB")
    
    # Collection stats
    coll_stats = db.command("collStats", collection.name)
    doc_count = coll_stats['count']
    print(f"\nCollection: {collection.name}")
    print(f"Documents: {doc_count}")
    print(f"Avg document size: {coll_stats.get('avgObjSize', 0) / 1024:.2f} KB")
    print(f"Total size: {coll_stats.get('size', 0) / 1024:.2f} KB")
    
    # Indexes
    indexes = collection.list_indexes()
    print(f"\nIndexes:")
    for idx in indexes:
        print(f"   - {idx['name']}: {idx['key']}")
    
    # Sample documents
    if doc_count > 0:
        print(f"\nüìÑ Sample document:")
        sample = collection.find_one()
        if sample:
            for key, value in list(sample.items())[:8]:  # ƒ∞lk 8 field
                if isinstance(value, str) and len(value) > 50:
                    value = value[:50] + "..."
                print(f"   {key}: {value}")


def main():
    """Ana fonksiyon - t√ºm setup i≈ülemleri"""
    
    print("="*60)
    print("üè• MongoDB Database Initializer - MediCrew")
    print("="*60)
    print()
    
    # 1. MongoDB baƒülantƒ±sƒ±
    client = test_mongodb_connection(MONGO_URI)
    
    # 2. Database olu≈ütur
    db = create_database(client, DB_NAME)
    
    # 3. Collection olu≈ütur
    collection = create_collection(db, COLLECTION_NAME)
    
    # 4. Index'leri olu≈ütur
    create_indexes(collection)
    
    # 5. Validation schema (opsiyonel)
    create_validation_schema(db, COLLECTION_NAME)
    
    # 6. Sample data ekle (test i√ßin)
    print()
    insert_sample = input("Sample test data eklemek ister misiniz? (y/n): ")
    if insert_sample.lower() == 'y':
        insert_sample_data(collection)
    
    # 7. ƒ∞statistikleri g√∂ster
    print_database_stats(db, collection)
    
    print("\n" + "="*60)
    print("‚úÖ MongoDB Database Initialization Complete!")
    print("="*60)
    print(f"\nüìç Connection String: {MONGO_URI}")
    print(f"üìç Database: {DB_NAME}")
    print(f"üìç Collection: {COLLECTION_NAME}")
    print("\nüí° Next Steps:")
    print("   1. MongoDB Compass'ta g√∂r√ºnt√ºleyin: mongodb://localhost:27017")
    print("   2. PubMed downloader script'ini √ßalƒ±≈ütƒ±rƒ±n")
    print("   3. Pinecone'a embedding'leri y√ºkleyin")
    print("\nüöÄ Hazƒ±rsƒ±nƒ±z!")
    
    client.close()


if __name__ == "__main__":
    main()